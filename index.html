<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kho t√†i li·ªáu sinh vi√™n</title>
  <meta name="description" content="T√¨m ki·∫øm, l·ªçc v√† xem t√†i li·ªáu h·ªçc t·∫≠p do sinh vi√™n chia s·∫ª.">
  <style>
    :root{
      --bg:#ffffff; --text:#111827; --muted:#6b7280; --bd:#e5e7eb; --chip:#f3f4f6; --primary:#2563eb;
      --subtle:#f9fafb; --card:#ffffff; --shadow:0 1px 2px rgba(0,0,0,.06),0 4px 24px rgba(0,0,0,.04);
      --hl-subject:#fff7d6; --hl-price:#e8fff0; --danger:#ef4444; --success:#059669;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif; color:var(--text); background:var(--bg); margin:0}

    .container{max-width:1120px; margin:0 auto; padding:20px 16px 56px}

    header{position:sticky; top:0; z-index:30; background:rgba(255,255,255,.8); backdrop-filter:saturate(180%) blur(8px); border-bottom:1px solid var(--bd)}
    .nav{display:flex; align-items:center; gap:14px; padding:10px 16px}
    .brand{display:flex; align-items:center; gap:10px; font-weight:800; letter-spacing:.2px}
    .logo{width:32px; height:32px; border-radius:8px; background:linear-gradient(135deg,#60a5fa,#34d399); display:inline-grid; place-items:center; color:#fff; font-weight:900}
    .nav-ctas{margin-left:auto; display:flex; gap:8px; flex-wrap:wrap}
    .btn{appearance:none; border:1px solid var(--bd); background:#fff; color:#111; padding:8px 12px; border-radius:10px; font-weight:600; text-decoration:none; transition:.15s; box-shadow:0 1px 0 rgba(0,0,0,.02); cursor:pointer}
    .btn:hover{transform:translateY(-1px); box-shadow:var(--shadow)}
    .btn.primary{background:var(--primary); color:#fff; border-color:transparent}

    /* Intro 1 c·ªôt ƒë·ªÉ ƒë·ªìng b·ªô ƒë·ªô r·ªông v·ªõi card kh√°c */
    .intro{display:grid; grid-template-columns:1fr; gap:16px; margin:18px 0 10px}
    .intro .card{padding:16px 18px}

    .card{background:var(--card); border:1px solid var(--bd); border-radius:16px; box-shadow:var(--shadow)}
    .card h2{margin:0 0 8px; font-size:18px}
    .muted{color:var(--muted)}

    .controls{display:grid; grid-template-columns:2fr 2fr auto; gap:10px; align-items:center; margin:14px 0 16px}
    .input{width:100%; padding:10px 12px; border:1px solid var(--bd); border-radius:12px; background:#fff}
    .select{padding:10px 12px; border:1px solid var(--bd); border-radius:12px; background:#fff}
    @media (max-width:840px){.controls{grid-template-columns:1fr 1fr;}}
    @media (max-width:560px){.controls{grid-template-columns:1fr;}}

    .chips{display:flex; gap:8px; flex-wrap:wrap; margin:6px 0 16px}
    .chip{background:var(--chip); border:1px solid var(--bd); color:#111; padding:6px 10px; border-radius:999px; font-size:13px; cursor:pointer}
    .chip[aria-pressed="true"], .chip.active{outline:2px solid var(--primary); outline-offset:1px}

    .results-head{display:flex; align-items:center; gap:10px; margin:8px 0}
    .results-head .count{font-weight:700}

    /* SUBJECT FOLDERS */
    #subjects{margin-top:12px}
    .folders{display:grid; grid-template-columns:repeat(auto-fill, minmax(180px, 1fr)); gap:12px}
    .folder{display:flex; gap:10px; align-items:center; border:1px solid var(--bd); border-radius:12px; padding:10px 12px; background:#fff; cursor:pointer; transition:.15s}
    .folder:hover{box-shadow:var(--shadow); transform:translateY(-1px)}
    .folder .icon{width:34px; height:34px; border-radius:10px; display:grid; place-items:center; background:linear-gradient(135deg,#dbeafe,#d1fae5)}
    .folder .name{font-weight:700}
    .folder .count{margin-left:auto; color:var(--muted); font-size:13px}

    .grid{display:grid; grid-template-columns:repeat(auto-fill, minmax(280px, 1fr)); gap:14px}

    .item{background:#fff; border:1px solid var(--bd); border-radius:16px; overflow:hidden; display:flex; flex-direction:column; padding:14px}
    .body{display:grid; gap:8px}
    .title{font-weight:800; line-height:1.35}
    .meta{display:grid; grid-template-columns:1fr 1fr; gap:6px 12px; font-size:14px}
    .label{color:var(--muted); white-space:nowrap}
    .pill{background:var(--hl-subject); border-radius:6px; padding:2px 6px; font-weight:700}
    .price{background:var(--hl-price); border-radius:6px; padding:2px 6px; font-weight:800}
    .actions{display:flex; gap:8px; flex-wrap:wrap; margin-top:4px}

    .contact-click{display:inline-block; padding:6px 10px; border-radius:10px; background:var(--subtle); border:1px dashed var(--bd); cursor:pointer}

    .skeleton{background:linear-gradient(90deg,#f4f4f5 25%,#f1f5f9 37%,#f4f4f5 63%); background-size:400% 100%; animation:shimmer 1.2s infinite}
    @keyframes shimmer{0%{background-position:100% 0}100%{background-position:0 0}}
    .sk-card{border:1px solid var(--bd); border-radius:16px; overflow:hidden; padding:14px}
    .sk-lines{display:grid; gap:10px}

    .state{border:1px dashed var(--bd); border-radius:16px; padding:24px; text-align:center; background:#fff}

    footer{margin-top:28px; color:var(--muted); font-size:14px}
    .help-links{display:flex; gap:8px; flex-wrap:wrap}

    /* Toast */
    .toast{position:fixed; left:50%; bottom:18px; transform:translateX(-50%); background:#111; color:#fff; padding:10px 14px; border-radius:12px; font-weight:700; opacity:0; pointer-events:none; transition:.25s; z-index:1000}
    .toast.show{opacity:1; transform:translateX(-50%) translateY(-4px)}
  </style>
</head>
<body>
  <header>
    <div class="nav container">
      <div class="brand"><span class="logo" aria-hidden>üìö</span> Kho t√†i li·ªáu sinh vi√™n</div>
      <div class="nav-ctas">
        <a class="btn primary" href="https://forms.gle/QWLXhVD4SZ1KJAvz5" target="_blank" rel="noopener">ƒêƒÉng b√†i b√°n t√†i li·ªáu</a>
        <a class="btn" href="#form-go-bai">G·ª° b√†i b√°n t√†i li·ªáu</a>
        <a class="btn" href="https://www.facebook.com/groups/969537278407183" target="_blank" rel="noopener">Group h·ªçc t·∫≠p</a>
        <a class="btn" href="https://www.facebook.com/groups/httpswww.facebook.comunishotrohoctap" target="_blank" rel="noopener">Group t√†i li·ªáu free</a>
        <a class="btn" href="https://www.facebook.com/unishotrohoctap" target="_blank" rel="noopener">H·ªó tr·ª£ h·ªçc t·∫≠p c√°c m√¥n</a>
      </div>
    </div>
  </header>

  <main class="container">
    <section class="intro">
      <div class="card">
        <h2>Gi·ªõi thi·ªáu</h2>
        <p>Trang n√†y gi√∫p sinh vi√™n <strong>t√¨m ki·∫øm nhanh</strong> s√°ch, t√†i li·ªáu, gi√°o tr√¨nh h·ªçc t·∫≠p do c·ªông ƒë·ªìng chia s·∫ª, b√°n l·∫°i. B·∫°n c√≥ th·ªÉ l·ªçc theo t√™n t√†i li·ªáu, m√¥n h·ªçc, gi√° b√°n v√† li√™n h·ªá ng∆∞·ªùi b√°n.M·ªçi th·∫Øc m·∫Øc xin vui l√≤ng li√™n h·ªá v·ªõi Admin.</p>
        <div class="help-links" style="margin-top:8px">
          <a class="btn" href="https://www.facebook.com/profile.php?id=61575981046841" target="_blank" rel="noopener">Li√™n h·ªá admin</a>
          <a class="btn" href="#danh-sach">Xem danh s√°ch ‚Üì</a>
        </div>
      </div>
    </section>

    <!-- SUBJECT FOLDERS SECTION -->
    <section id="subjects" class="card" style="padding:12px 14px;">
      <div style="display:flex; align-items:center; gap:10px; margin-bottom:8px">
        <h2 style="margin:0">M√¥n h·ªçc</h2>
        <button id="clearSubject" class="btn" type="button" style="margin-left:auto">Hi·ªÉn th·ªã t·∫•t c·∫£</button>
      </div>
      <div id="subjectsGrid" class="folders" aria-label="Danh s√°ch m√¥n h·ªçc (folder)"></div>
    </section>

    <section aria-label="B·ªô l·ªçc v√† s·∫Øp x·∫øp" class="card" style="padding:12px 14px; margin-top:12px">
      <div class="controls">
        <input id="qName" class="input" placeholder="üîé T√¨m theo t√™n t√†i li·ªáu..." aria-label="T√¨m theo t√™n t√†i li·ªáu" />
        <input id="qSubject" class="input" placeholder="üìö T√¨m theo m√¥n h·ªçc..." aria-label="T√¨m theo m√¥n h·ªçc" />
        <select id="sort" class="select" aria-label="S·∫Øp x·∫øp">
          <option value="newest">M·ªõi nh·∫•t</option>
          <option value="priceAsc">Gi√° tƒÉng d·∫ßn</option>
          <option value="priceDesc">Gi√° gi·∫£m d·∫ßn</option>
          <option value="name">Theo t√™n (A‚ÜíZ)</option>
        </select>
      </div>
      <div id="chips" class="chips" aria-label="B·ªô l·ªçc nhanh theo m√¥n h·ªçc"></div>
      <div class="results-head"><span id="count" class="count">0</span><span class="muted">k·∫øt qu·∫£</span><span id="activeFilters" class="muted"></span></div>
    </section>

    <section id="danh-sach" style="margin-top:12px">
      <div id="results" class="grid" aria-live="polite"></div>
    </section>

    <!-- G·ª† B√ÄI: input + submit ƒë·∫øn Google Forms -->
    <section id="form-go-bai" class="card" style="padding:12px 14px; margin-top:12px">
      <div style="display:flex; align-items:center; gap:10px; margin-bottom:8px">
        <h2 style="margin:0">G·ª° b√†i ƒë√£ ƒëƒÉng</h2>
      
      </div>
      <div class="muted" style="margin-bottom:8px">Nh·∫≠p <strong>M√£ ƒë∆°n h√†ng</strong> v√† b·∫•m G·ª≠i (N·∫øu kh√¥ng bi·∫øt m√£ ƒë∆°n h√†ng c·ªßa m√¨nh h√£y truy c·∫≠p v√†o Gmail ƒë·ªÉ t√¨m ki·∫øm m√£ ƒë∆°n m√† ch√∫ng t√¥i ƒë√£ g·ª≠i cho b·∫°n). H·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ª°.</div>
      <form id="removeForm" style="display:flex; gap:8px; flex-wrap:wrap">
        <input id="orderCode" class="input" placeholder="Nh·∫≠p m√£ ƒë∆°n h√†ng (v√≠ d·ª•: ABC123...)" aria-label="M√£ ƒë∆°n h√†ng" required />
        <button class="btn primary" type="submit">G·ª≠i y√™u c·∫ßu g·ª°</button>
      </form>
      <div id="removeHint" class="muted" style="margin-top:6px"></div>
    </section>

    <template id="tpl-skeleton">
      <div class="sk-card">
        <div class="sk-lines">
          <div class="skeleton" style="height:14px; width:70%"></div>
          <div class="skeleton" style="height:12px; width:55%"></div>
          <div class="skeleton" style="height:12px; width:80%"></div>
        </div>
      </div>
    </template>
  </main>

  <footer class="container">
    <div class="state muted">Ngu·ªìn d·ªØ li·ªáu ƒë∆∞·ª£c ƒë·ªìng b·ªô t·ª´ Google Sheets (ch·∫ø ƒë·ªô ch·ªâ ƒë·ªçc).</div>
  </footer>

  <!-- Toast -->
  <div id="toast" class="toast" role="status" aria-live="polite">ƒê√£ sao ch√©p</div>

  <script>
  const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRL7VwTAlQldOBxOR3arotJCVv2fWLmoB3Hr6WslMdS2z_8iHM5jBnp-nK0Wvf5Ko90TLCuxgxoLihT/pub?gid=759690707&single=true&output=csv";
  // Th√™m c·ªôt h√¨nh ·∫£nh (index 7)
  const COL = { ts:0, email:1, name:2, subject:3, contact:4, price:5, note:6, img:7 };

  const $ = sel => document.querySelector(sel);
  const resultsEl = $('#results');
  const countEl = $('#count');
  const chipsEl = $('#chips');
  const qName = $('#qName');
  const qSubject = $('#qSubject');
  const sortSel = $('#sort');
  const activeFilters = $('#activeFilters');
  const subjectsGrid = $('#subjectsGrid');
  const clearSubjectBtn = $('#clearSubject');
  const toast = $('#toast');

  // Remove form elements
  const removeForm = $('#removeForm');
  const orderCode = $('#orderCode');
  const removeHint = $('#removeHint');

  let RAW = [];
  let SUBJECTS = new Set();
  let selectedSubjects = new Set();

  const getCell = (r,i) => (i>=0 && i<r.length ? r[i] : '');
  const escapeHTML = s => (s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]));
  const nl2br = s => (s||'').replace(/\r?\n/g,'<br>');
  const toNumber = s => { const n = parseInt(String(s||'').replace(/[^\d]/g,''), 10); return Number.isFinite(n) ? n : NaN };
  const formatPrice = v => Number.isFinite(v) ? v.toLocaleString('vi-VN') + ' ‚Ç´' : (v||'');
  const debounce = (fn, ms=180) => { let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), ms); } };

  const FORM_ID = "1FAIpQLSdDce5ifEQTiHhRbFzx1SLAqtyOCuBA6-6cygfqRp3JLF6lDA";
  const ENTRY_ID = "entry.315304563";

  function parseCSV(text){
    const rows=[]; let row=[]; let cur=''; let inQ=false;
    for(let i=0;i<text.length;i++){
      const c=text[i], n=text[i+1];
      if(inQ){ if(c==='"'){ if(n==='"'){cur+='"'; i++;} else inQ=false; } else cur+=c; }
      else{
        if(c==='"') inQ=true; else if(c===','){ row.push(cur); cur=''; }
        else if(c==='\n'){ row.push(cur); rows.push(row); row=[]; cur=''; }
        else if(c==='\r'){} else cur+=c;
      }
    }
    row.push(cur); rows.push(row);
    return rows.filter(r => r.some(cell => (cell||'').trim()!==''));
  }

  function parseImages(s){
    const raw = (s||'').split(/[\n,]+/).map(x=>x.trim()).filter(Boolean);
    return raw;
  }

  function isValidUrl(u){
    try{ const x=new URL(u); return x.protocol==='http:'||x.protocol==='https:'; }catch{ return false; }
  }

  function mapRow(r){
    const rawPrice = getCell(r, COL.price);
    const priceNum = toNumber(rawPrice);
    return {
      ts: new Date(getCell(r, COL.ts)),
      email: getCell(r, COL.email),
      name: getCell(r, COL.name).trim(),
      subject: getCell(r, COL.subject).trim(),
      subjectKey: (getCell(r, COL.subject)||'').trim().toLowerCase(),
      contact: getCell(r, COL.contact),
      priceRaw: rawPrice,
      price: Number.isFinite(priceNum) ? priceNum : null,
      note: getCell(r, COL.note),
      images: parseImages(getCell(r, COL.img))
    };
  }

  function formatContactHTML(s){
    const raw=s||'';
    const email=raw.match(/[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}/i);
    const phone=raw.match(/(\+?\d[\d\s().-]{6,}\d)/);
    const parts=[];
    if(email) parts.push(`<a href="mailto:${email[0]}">${escapeHTML(email[0])}</a>`);
    if(phone) parts.push(`<a href="tel:${phone[0].replace(/[^\d+]/g,'')}">${escapeHTML(phone[0])}</a>`);
    if(!parts.length) return escapeHTML(raw);
    const extra=raw.replace(email?.[0]||'','').replace(phone?.[0]||'','').trim();
    return parts.join(' ¬∑ ') + (extra?` <span class="muted">${escapeHTML(extra)}</span>`:'');
  }

  function showToast(msg="ƒê√£ sao ch√©p"){
    toast.textContent = msg;
    toast.classList.add('show');
    setTimeout(()=>toast.classList.remove('show'), 1400);
  }

  function copyTextSilently(text){
    if(!text) return;
    navigator.clipboard.writeText(text).then(()=>showToast("ƒê√£ sao ch√©p")).catch(()=>showToast("Kh√¥ng th·ªÉ sao ch√©p"));
  }

  function renderSkeleton(n=8){
    resultsEl.className = 'grid';
    resultsEl.innerHTML = Array.from({length:n}).map(()=>$('#tpl-skeleton').innerHTML).join('');
    countEl.textContent = '...';
  }

  function buildChips(){
    chipsEl.innerHTML = '';
    const subjects = Array.from(SUBJECTS).sort((a,b)=>a.localeCompare(b,'vi',{sensitivity:'base'}));
    subjects.slice(0,24).forEach(sub => {
      const btn = document.createElement('button');
      btn.className = 'chip';
      btn.type = 'button';
      btn.setAttribute('aria-pressed','false');
      btn.textContent = sub;
      btn.addEventListener('click', ()=>{
        const key = sub.toLowerCase();
        selectedSubjects = new Set([key]);
        qSubject.value = sub;
        render();
        document.getElementById('danh-sach').scrollIntoView({behavior:'smooth'});
      });
      chipsEl.appendChild(btn);
    });
  }

  function buildSubjectFolders(index){
    subjectsGrid.innerHTML = '';
    const entries = Object.entries(index).sort((a,b)=> a[1].name.localeCompare(b[1].name,'vi',{sensitivity:'base'}));
    entries.forEach(([key,info])=>{
      const el = document.createElement('button');
      el.type = 'button';
      el.className = 'folder';
      el.innerHTML = `<span class="icon">üìÅ</span><span class="name">${escapeHTML(info.name)}</span><span class="count">${info.count}</span>`;
      el.addEventListener('click', ()=>{
        selectedSubjects = new Set([key]);
        qSubject.value = info.name;
        render();
        document.getElementById('danh-sach').scrollIntoView({behavior:'smooth'});
      });
      subjectsGrid.appendChild(el);
    });
  }

  function applyFilters(data){
    const nameTerm = (qName.value||'').toLowerCase().trim();
    const subjectTerm = (qSubject.value||'').toLowerCase().trim();
    return data.filter(it=>{
      const okName = !nameTerm || it.name.toLowerCase().includes(nameTerm);
      const okSubjectText = !subjectTerm || it.subjectKey.includes(subjectTerm);
      const okSubjectChip = !selectedSubjects.size || selectedSubjects.has(it.subjectKey);
      return okName && okSubjectText && okSubjectChip;
    });
  }

  function applySort(data){
    const v = sortSel.value;
    const arr = data.slice();
    if(v==='newest') arr.sort((a,b)=>(b.ts - a.ts));
    else if(v==='priceAsc') arr.sort((a,b)=> ( (a.price ?? Infinity) - (b.price ?? Infinity) ));
    else if(v==='priceDesc') arr.sort((a,b)=> ( (b.price ?? -Infinity) - (a.price ?? -Infinity) ));
    else if(v==='name') arr.sort((a,b)=> a.name.localeCompare(b.name,'vi',{sensitivity:'base'}));
    return arr;
  }

  function render(){
    const filtered = applyFilters(RAW);
    const sorted = applySort(filtered);

    countEl.textContent = String(sorted.length);
    const activeStr = [];
    if(qName.value) activeStr.push(`T√™n: "${escapeHTML(qName.value)}"`);
    if(qSubject.value) activeStr.push(`M√¥n: "${escapeHTML(qSubject.value)}"`);
    if(selectedSubjects.size) activeStr.push(`${selectedSubjects.size} m√¥n`);
    activeFilters.innerHTML = activeStr.length ? `¬∑ <span class="muted">B·ªô l·ªçc: ${activeStr.join(', ')}</span>` : '';

    resultsEl.className = 'grid';

    if(!sorted.length){
      resultsEl.innerHTML = `<div class="state">Kh√¥ng c√≥ k·∫øt qu·∫£ ph√π h·ª£p. H√£y th·ª≠ t·ª´ kh√≥a kh√°c ho·∫∑c b·ªè b·ªõt b·ªô l·ªçc.</div>`;
      return;
    }

    resultsEl.innerHTML = sorted.map(it=>{
      const price = it.price!=null ? `<span class="price">${escapeHTML(formatPrice(it.price))}</span>` : `<span class="muted">Li√™n h·ªá</span>`;
      const firstImg = (it.images && it.images.length && isValidUrl(it.images[0])) ? it.images[0] : '';
      const imgBtn = firstImg ? `<a class="btn" href="${escapeHTML(firstImg)}" target="_blank" rel="noopener">Xem h√¨nh ·∫£nh</a>` : '';
      const contactHTML = formatContactHTML(it.contact);
      const contactRaw = (it.contact||'').trim();
      return `
        <article class="item" tabindex="0">
          <div class="body">
            <div class="title">${escapeHTML(it.name)}</div>
            <div class="meta">
              <div><span class="label">M√¥n h·ªçc:</span> <span class="pill">${escapeHTML(it.subject)}</span></div>
              <div><span class="label">Gi√° b√°n:</span> ${price}</div>
              <div style="grid-column:1 / -1">
                <span class="label">Li√™n h·ªá:</span>
                <span class="contact-click" data-copy="${escapeHTML(contactRaw)}">${contactHTML}</span>
              </div>
            </div>
            ${it.note ? `<div class="muted">${nl2br(escapeHTML(it.note))}</div>` : ''}
            <div class="actions">
              ${imgBtn}
            </div>
          </div>
        </article>`;
    }).join('');

    // Click ƒë·ªÉ copy li√™n h·ªá (·∫©n)
    resultsEl.querySelectorAll('.contact-click').forEach(el=>{
      el.addEventListener('click', ()=>{
        const v = el.getAttribute('data-copy')||'';
        copyTextSilently(v);
      });
    });
  }

  const onInput = debounce(()=> render(), 200);
  qName.addEventListener('input', onInput);
  qSubject.addEventListener('input', onInput);
  sortSel.addEventListener('change', render);
  clearSubjectBtn.addEventListener('click', ()=>{ selectedSubjects.clear(); qSubject.value=''; render(); });

  // Submit g·ª° b√†i qua Google Forms (kh√¥ng y√™u c·∫ßu ƒëƒÉng nh·∫≠p)
  removeForm.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const code = (orderCode.value||'').trim();
    if(!code){ orderCode.focus(); return; }
    try{
      const url = `https://docs.google.com/forms/d/e/${FORM_ID}/formResponse`;
      const body = new URLSearchParams();
      body.append(ENTRY_ID, code);
      await fetch(url, { method:'POST', mode:'no-cors', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body });
      showToast("ƒê√£ g·ª≠i y√™u c·∫ßu g·ª°");
      removeHint.textContent = "ƒê√£ g·ª≠i y√™u c·∫ßu. N·∫øu c·∫ßn c·∫≠p nh·∫≠t nhanh, li√™n h·ªá admin.";
      orderCode.value = "";
    }catch(err){
      console.error(err);
      showToast("G·ª≠i th·∫•t b·∫°i");
      removeHint.textContent = "Kh√¥ng g·ª≠i ƒë∆∞·ª£c y√™u c·∫ßu, vui l√≤ng th·ª≠ l·∫°i ho·∫∑c m·ªü Google Form.";
    }
  });

  (function init(){
  renderSkeleton(6);
  fetch(CSV_URL).then(r=>r.text()).then(txt=>{
    const rows = parseCSV(txt);
    const body = rows.slice(1);
    RAW = body.map(mapRow).filter(r => (r.name||'').trim()!=='' || (r.subject||'').trim()!=='');
    
    // --- S·ª≠a t·∫°i ƒë√¢y ---
    const index = {};
    RAW.forEach(it=>{
      const key = it.subjectKey || '';
      if(!key) return;
      if(!index[key]) index[key] = { name: it.subject || '(Kh√¥ng r√µ)', count:0 };
      index[key].count++;
    });
    SUBJECTS = new Set(Object.values(index).map(v=>v.name));
    buildChips();
    buildSubjectFolders(index);
    // -------------------

    render();
  }).catch(err=>{
    console.error(err);
    resultsEl.innerHTML = `<div class="state">Kh√¥ng t·∫£i ƒë∆∞·ª£c d·ªØ li·ªáu. Vui l√≤ng ki·ªÉm tra CSV ho·∫∑c th·ª≠ l·∫°i.</div>`;
    countEl.textContent = '0';
  });
})();
  </script>
</body>
</html>
